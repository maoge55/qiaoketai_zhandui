{% extends "admin_base.html" %}
{% block admin_content %}
<h1 style="margin-top:0;">荣耀管理</h1>
<p class="meta">管理荣耀殿堂条目，可置顶、下架、删除。删除仅逻辑删除。</p>

<div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin: 12px 0 18px;">
  <input class="qk-input" id="ach-search" placeholder="搜索标题/成员昵称/邮箱" style="min-width:220px;" />
  <select class="qk-input" id="ach-status-filter" style="width:140px;">
    <option value="">全部(除删除)</option>
    <option value="active">active</option>
    <option value="archived">archived</option>
    <option value="deleted">deleted</option>
  </select>
  <button class="qk-btn qk-btn-primary" id="btn-ach-reload">刷新列表</button>
  <a class="qk-btn qk-btn-outline" href="/admin/achievements/new">新增荣耀</a>
  <span class="meta" id="ach-status-text"></span>
</div>

<div style="overflow:auto;">
  <table class="qk-table" style="width:100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">ID</th>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">标题</th>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">成员</th>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">赛季/版本</th>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">结果</th>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">状态</th>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">置顶</th>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">成就日期</th>
        <th style="text-align:left; padding:10px; border-bottom: 1px solid var(--border-color);">操作</th>
      </tr>
    </thead>
    <tbody id="ach-tbody"></tbody>
  </table>
</div>
{% endblock %}

{% block body_extra %}
<script>
async function adminFetch(url, options = {}) {
  const token = getToken();
  if (!token) return (window.location.href = "/login");
  const headers = options.headers || {};
  headers["Authorization"] = "Bearer " + token;
  options.headers = headers;
  return fetch(url, options);
}

function fmtDate(v) {
  if (!v) return "";
  try {
    return new Date(v).toLocaleString();
  } catch (e) { return v; }
}

async function loadAchievements(page = 1) {
  const search = document.getElementById("ach-search").value.trim();
  const status = document.getElementById("ach-status-filter").value;
  const statusText = document.getElementById("ach-status-text");
  const tbody = document.getElementById("ach-tbody");
  statusText.textContent = "加载中...";
  tbody.innerHTML = "";

  const params = new URLSearchParams({ page, page_size: 50 });
  if (search) params.append("search", search);
  if (status) params.append("status", status);

  const res = await adminFetch(`/api/admin/achievements?${params.toString()}`);
  const data = await res.json();
  if (!res.ok) {
    statusText.textContent = "";
    return alert(data.detail || "加载失败");
  }

  for (const a of data.items) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:10px; border-bottom: 1px solid var(--border-color);">#${a.id}</td>
      <td style="padding:10px; border-bottom: 1px solid var(--border-color);">${a.title || ''}</td>
      <td style="padding:10px; border-bottom: 1px solid var(--border-color);">
        <div>${a.member_nickname || ''}</div>
        <div class="meta" style="margin-top:4px;">${a.member_email || ''}</div>
      </td>
      <td style="padding:10px; border-bottom: 1px solid var(--border-color);">${a.season_or_version || ''}</td>
      <td style="padding:10px; border-bottom: 1px solid var(--border-color);">${a.rank_or_result || ''}</td>
      <td style="padding:10px; border-bottom: 1px solid var(--border-color);">
        <select class="qk-input ach-status" data-id="${a.id}" style="min-width:120px;">
          <option value="active">active</option>
          <option value="archived">archived</option>
          <option value="deleted">deleted</option>
        </select>
      </td>
      <td style="padding:10px; border-bottom: 1px solid var(--border-color);">
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="ach-pin" data-id="${a.id}" ${a.is_pinned ? "checked" : ""} />
          <span class="meta">置顶</span>
        </label>
      </td>
      <td style="padding:10px; border-bottom: 1px solid var(--border-color);">${fmtDate(a.achieved_at)}</td>
      <td style="padding:10px; border-bottom: 1px solid var(--border-color); display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <a class="qk-btn qk-btn-outline" href="/admin/achievements/${a.id}/edit">编辑</a>
        <button class="qk-btn qk-btn-outline ach-save" data-id="${a.id}">保存</button>
        <button class="qk-btn qk-btn-outline ach-delete" data-id="${a.id}">删除</button>
      </td>
    `;
    tbody.appendChild(tr);
    const sel = tr.querySelector("select.ach-status");
    sel.value = a.status || "active";
  }

  statusText.textContent = `共 ${data.total} 条`;
}

async function saveAchievementRow(id) {
  const statusSel = document.querySelector(`select.ach-status[data-id="${id}"]`);
  const isPinned = !!document.querySelector(`input.ach-pin[data-id="${id}"]`)?.checked;
  const statusVal = statusSel ? statusSel.value : "active";

  const res = await adminFetch(`/api/admin/achievements/${id}`, {
    method: "PUT",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ status: statusVal, is_pinned: isPinned }),
  });
  const data = await res.json();
  if (!res.ok) return alert(data.detail || "保存失败");
  alert("保存成功");
  loadAchievements();
}

async function deleteAchievement(id) {
  if (!confirm("确认删除？将标记为 deleted")) return;
  const res = await adminFetch(`/api/admin/achievements/${id}`, { method: "DELETE" });
  const data = await res.json();
  if (!res.ok) return alert(data.detail || "删除失败");
  alert("删除成功");
  loadAchievements();
}

function bindEvents() {
  document.getElementById("btn-ach-reload")?.addEventListener("click", () => loadAchievements());
  document.getElementById("ach-status-filter")?.addEventListener("change", () => loadAchievements());
  document.getElementById("ach-search")?.addEventListener("keyup", (e) => {
    if (e.key === "Enter") loadAchievements();
  });

  document.body.addEventListener("click", (e) => {
    if (e.target.classList.contains("ach-save")) {
      const id = e.target.dataset.id;
      saveAchievementRow(id);
    }
    if (e.target.classList.contains("ach-delete")) {
      const id = e.target.dataset.id;
      deleteAchievement(id);
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  bindEvents();
  loadAchievements();
});
</script>
{% endblock %}
