{% extends "base.html" %}
{% block title %}å‘å¸ƒæ”»ç•¥ - ç«æŠ€åœºå®å…¸{% endblock %}

{% block head_extra %}
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />
  <style>
    /* å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ•´ä½“é£æ ¼ï¼Œå°½é‡è´´è¿‘ç«™å†…å¡ç‰‡ */
    #g-toolbar {
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
    }
    #g-editor {
      min-height: 420px;
      border-bottom-left-radius: 14px;
      border-bottom-right-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-top: 0;
      background: rgba(15, 23, 42, 0.35);
      color: #e5e7eb;
    }
    .ql-snow .ql-toolbar button,
    .ql-snow .ql-toolbar .ql-picker-label {
      color: #e5e7eb;
    }
    .ql-container.ql-snow {
      border: 0;
    }
    .ql-editor {
      padding: 14px 16px;
      font-size: 15px;
      line-height: 1.75;
    }
    .ql-editor a { color: #38bdf8; }
  </style>
{% endblock %}

{% block content %}
<div class="qk-container">
  <div class="card">
    <h1>å‘å¸ƒç«æŠ€åœºæ”»ç•¥</h1>
    <p class="meta">ä»…å¤§ç¥æˆå‘˜/ç®¡ç†å‘˜å¯å‘å¸ƒã€‚æ”¯æŒå¯Œæ–‡æœ¬ï¼šå›¾ç‰‡ã€è¶…é“¾æ¥ã€æ ‡ç­¾ã€é™„ä»¶ï¼ˆæ–‡ä»¶é“¾æ¥ï¼‰ç­‰ã€‚</p>

    <form id="guide-new-form" style="display:grid; gap: 14px; margin-top: 16px;">
      <label class="qk-field">
        <span class="qk-label">æ ‡é¢˜</span>
        <input id="g-title" class="qk-input" placeholder="ä¾‹å¦‚ï¼šæ–°ç‰ˆæœ¬ç«æŠ€åœºé€‰ç‰Œæ€è·¯ï¼ˆ2025.12ï¼‰" required />
      </label>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 14px;">
        <label class="qk-field">
          <span class="qk-label">åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</span>
          <input id="g-category" class="qk-input" placeholder="ä¾‹å¦‚ï¼šé€‰ç‰Œ / å¯¹å±€ / èŒä¸šæŒ‡å—" />
        </label>

        <label class="qk-field">
          <span class="qk-label">æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰</span>
          <input id="g-tags" class="qk-input" placeholder="ä¾‹å¦‚ï¼šå¾·é²ä¼Š, æ–°ç‰ˆæœ¬, Arena" />
        </label>
      </div>

      {% if current_user and current_user.role.value == 'admin' %}
      <label class="qk-field" style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="g-featured" />
        <span class="qk-label" style="margin:0;">è®¾ä¸ºé¦–é¡µç²¾é€‰</span>
      </label>
      {% endif %}

      <div class="qk-field">
        <span class="qk-label">æ­£æ–‡</span>

        <!-- è‡ªå®šä¹‰å·¥å…·æ ï¼šå¢åŠ â€œé™„ä»¶â€æŒ‰é’®ï¼ˆğŸ“ï¼‰ -->
        <div id="g-toolbar">
          <span class="ql-formats">
            <select class="ql-header">
              <option selected></option>
              <option value="1">H1</option>
              <option value="2">H2</option>
              <option value="3">H3</option>
            </select>
          </span>
          <span class="ql-formats">
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <button class="ql-underline"></button>
            <button class="ql-strike"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-blockquote"></button>
            <button class="ql-code-block"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-list" value="ordered"></button>
            <button class="ql-list" value="bullet"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-link"></button>
            <button class="ql-image"></button>
            <button class="ql-attachment" title="æ’å…¥é™„ä»¶">ğŸ“</button>
          </span>
          <span class="ql-formats">
            <button class="ql-clean"></button>
          </span>
        </div>

        <div id="g-editor"></div>
        <!-- éšè—å­—æ®µï¼šæäº¤æ—¶å†™å…¥ç¼–è¾‘å™¨ HTML -->
        <textarea id="g-content" style="display:none;"></textarea>

        <small class="meta">
          å®‰å…¨æç¤ºï¼šæ”»ç•¥æ­£æ–‡ä¼šåœ¨å‰ç«¯æ¸²æŸ“ï¼Œè¯·ä¸è¦ç²˜è´´æœªçŸ¥è„šæœ¬å†…å®¹ã€‚æœåŠ¡ç«¯ä¼šå¯¹ HTML åšåŸºç¡€æ¸…æ´—ã€‚
        </small>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button type="submit" class="qk-btn qk-btn-primary">å‘å¸ƒ</button>
        <a href="/guides" class="qk-btn qk-btn-outline">è¿”å›åˆ—è¡¨</a>
        <span id="g-status" class="meta"></span>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("guide-new-form");
    if (!form) return;

    const status = document.getElementById("g-status");
    const editorEl = document.getElementById("g-editor");
    const contentField = document.getElementById("g-content");

    // ä¸Šä¼ å·¥å…·
    async function uploadTo(url, file) {
      const token = getToken();
      if (!token) {
        window.location.href = "/login";
        return null;
      }

      const fd = new FormData();
      fd.append("file", file);

      const res = await fetch(url, {
        method: "POST",
        headers: { Authorization: "Bearer " + token },
        body: fd,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || "ä¸Šä¼ å¤±è´¥");
      return data.url;
    }

    // åˆå§‹åŒ– Quill
    const quill = new Quill(editorEl, {
      theme: "snow",
      modules: {
        toolbar: {
          container: "#g-toolbar",
          handlers: {
            image: async function () {
              const input = document.createElement("input");
              input.type = "file";
              input.accept = "image/*";
              input.click();
              input.onchange = async () => {
                const file = input.files && input.files[0];
                if (!file) return;
                try {
                  status.textContent = "å›¾ç‰‡ä¸Šä¼ ä¸­...";
                  const url = await uploadTo("/api/uploads/image", file);
                  status.textContent = "";
                  if (!url) return;
                  const range = quill.getSelection(true) || { index: quill.getLength() };
                  quill.insertEmbed(range.index, "image", url, "user");
                  quill.setSelection(range.index + 1);
                } catch (err) {
                  status.textContent = "";
                  alert(err.message || "å›¾ç‰‡ä¸Šä¼ å¤±è´¥");
                }
              };
            },
            attachment: async function () {
              const input = document.createElement("input");
              input.type = "file";
              input.accept = "*/*";
              input.click();
              input.onchange = async () => {
                const file = input.files && input.files[0];
                if (!file) return;
                try {
                  status.textContent = "é™„ä»¶ä¸Šä¼ ä¸­...";
                  const url = await uploadTo("/api/uploads/file", file);
                  status.textContent = "";
                  if (!url) return;
                  const range = quill.getSelection(true) || { index: quill.getLength() };
                  // æ’å…¥ä¸€ä¸ªå¯ç‚¹å‡»çš„æ–‡ä»¶é“¾æ¥
                  quill.insertText(range.index, file.name, "link", url);
                  quill.insertText(range.index + file.name.length, " ");
                  quill.setSelection(range.index + file.name.length + 1);
                } catch (err) {
                  status.textContent = "";
                  alert(err.message || "é™„ä»¶ä¸Šä¼ å¤±è´¥");
                }
              };
            },
          },
        },
      },
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const token = getToken();
      if (!token) return (window.location.href = "/login");

      const title = document.getElementById("g-title").value.trim();
      const category = document.getElementById("g-category").value.trim();
      const tagsRaw = document.getElementById("g-tags").value.trim();
      const featuredEl = document.getElementById("g-featured");
      const is_featured = featuredEl ? !!featuredEl.checked : false;

      // å°†ç¼–è¾‘å™¨ HTML å†™å…¥éšè—å­—æ®µ
      const html = quill.root.innerHTML || "";
      contentField.value = html;
      const content = contentField.value;

      const tags = tagsRaw ? tagsRaw.split(/[,ï¼Œ]/).map(s => s.trim()).filter(Boolean) : [];

      status.textContent = "å‘å¸ƒä¸­...";

      const res = await fetch("/api/articles", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token,
        },
        body: JSON.stringify({
          title,
          content,
          category: category || null,
          is_featured,
          tags,
        }),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        status.textContent = "";
        return alert(data.detail || "å‘å¸ƒå¤±è´¥");
      }

      status.textContent = "å‘å¸ƒæˆåŠŸï¼Œè·³è½¬ä¸­...";
      window.location.href = `/guides/${data.id}`;
    });
  });
</script>
{% endblock %}
