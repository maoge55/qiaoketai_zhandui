{% extends "admin_base.html" %}
{% block admin_content %}
<h1 style="margin-top:0;">首页配置</h1>
<p class="meta">这里编辑的是 HomepageConfig。为了简化，全部用中文描述，直接填网址或文本，后台自动保存。</p>

<div style="display:flex; gap:10px; align-items:center; margin: 12px 0 18px;">
  <button class="qk-btn qk-btn-primary" id="btn-load-homepage">加载配置</button>
  <button class="qk-btn qk-btn-outline" id="btn-save-homepage">保存配置</button>
  <span class="meta" id="admin-homepage-status"></span>
</div>

<form id="homepage-form" style="display:grid; gap: 14px; max-width: 820px;">
  <label class="qk-field">
    <span class="qk-label">队标 URL</span>
    <input class="qk-input" id="hp-team-logo" placeholder="/static/img/logo.png" />
  </label>

  <label class="qk-field">
    <span class="qk-label">Banner 图片地址（多条请用换行分隔）</span>
    <textarea class="qk-textarea" id="hp-banner" rows="6" placeholder='例如：
/static/image/banner1.png
https://example.com/banner2.jpg'></textarea>
  </label>

  <label class="qk-field">
    <span class="qk-label">精选成就文案（多条换行）</span>
    <textarea class="qk-textarea" id="hp-ach" rows="6" placeholder='例如：
毛哥：本周登顶
小明：均场 8 胜'></textarea>
  </label>

  <label class="qk-field">
    <span class="qk-label">精选成员（填 QQ 号或用户名，多条换行）</span>
    <textarea class="qk-textarea" id="hp-mem" rows="6" placeholder='例如：
qq123456
昵称：毛哥'></textarea>
  </label>
</form>
{% endblock %}

{% block body_extra %}
<script>
async function adminFetch(url, options = {}) {
  const token = getToken();
  if (!token) return (window.location.href = "/login");
  const headers = options.headers || {};
  headers["Authorization"] = "Bearer " + token;
  options.headers = headers;
  return fetch(url, options);
}

function toLines(text) {
  return (text || "")
    .split(/\r?\n/)
    .map((s) => s.trim())
    .filter(Boolean);
}

async function loadHomepage() {
  const status = document.getElementById("admin-homepage-status");
  status.textContent = "加载中...";
  const res = await adminFetch("/api/admin/homepage");
  const data = await res.json();
  if (!res.ok) {
    status.textContent = "";
    return alert(data.detail || "加载失败");
  }
  document.getElementById("hp-team-logo").value = data.team_logo_url || "";
  document.getElementById("hp-banner").value = Array.isArray(data.banner_images) ? data.banner_images.join("\n") : "";
  document.getElementById("hp-ach").value = Array.isArray(data.featured_achievements) ? data.featured_achievements.join("\n") : "";
  document.getElementById("hp-mem").value = Array.isArray(data.featured_members) ? data.featured_members.join("\n") : "";
  status.textContent = "已加载";
}

async function saveHomepage() {
  const status = document.getElementById("admin-homepage-status");
  status.textContent = "保存中...";
  const payload = {
    team_logo_url: document.getElementById("hp-team-logo").value.trim() || null,
    banner_images: toLines(document.getElementById("hp-banner").value),
    featured_achievements: toLines(document.getElementById("hp-ach").value),
    featured_members: toLines(document.getElementById("hp-mem").value),
  };

  const res = await adminFetch("/api/admin/homepage", {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload),
  });
  const data = await res.json();
  if (!res.ok) {
    status.textContent = "";
    return alert(data.detail || "保存失败");
  }
  status.textContent = "保存成功";
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btn-load-homepage")?.addEventListener("click", loadHomepage);
  document.getElementById("btn-save-homepage")?.addEventListener("click", saveHomepage);
  loadHomepage();
});
</script>
{% endblock %}
