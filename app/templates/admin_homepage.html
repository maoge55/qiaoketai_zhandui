{% extends "admin_base.html" %}
{% block admin_content %}
<h1 style="margin-top:0;">首页配置</h1>
<p class="meta">这里编辑的是 HomepageConfig（主要给未来首页装修用）。当前首页展示更多依赖「精选文章 / 精选成就 / 高分大神」查询逻辑。</p>

<div style="display:flex; gap:10px; align-items:center; margin: 12px 0 18px;">
  <button class="qk-btn qk-btn-primary" id="btn-load-homepage">加载配置</button>
  <button class="qk-btn qk-btn-outline" id="btn-save-homepage">保存配置</button>
  <span class="meta" id="admin-homepage-status"></span>
</div>

<form id="homepage-form" style="display:grid; gap: 14px; max-width: 820px;">
  <label class="qk-field">
    <span class="qk-label">队标 URL</span>
    <input class="qk-input" id="hp-team-logo" placeholder="/static/img/logo.png" />
  </label>

  <label class="qk-field">
    <span class="qk-label">banner_images（JSON 数组/对象）</span>
    <textarea class="qk-textarea" id="hp-banner" rows="6" placeholder='例如：["/static/image/Sylv.png"] 或 {"a": "..."}'></textarea>
  </label>

  <label class="qk-field">
    <span class="qk-label">featured_achievements（JSON）</span>
    <textarea class="qk-textarea" id="hp-ach" rows="6" placeholder='例如：{"title":"..."}'></textarea>
  </label>

  <label class="qk-field">
    <span class="qk-label">featured_members（JSON）</span>
    <textarea class="qk-textarea" id="hp-mem" rows="6" placeholder='例如：{"ids":[1,2,3]}'></textarea>
  </label>
</form>
{% endblock %}

{% block body_extra %}
<script>
async function adminFetch(url, options = {}) {
  const token = getToken();
  if (!token) return (window.location.href = "/login");
  const headers = options.headers || {};
  headers["Authorization"] = "Bearer " + token;
  options.headers = headers;
  return fetch(url, options);
}

function safeParseJson(text) {
  const t = (text || "").trim();
  if (!t) return null;
  try { return JSON.parse(t); } catch(e) { throw new Error("JSON 解析失败：" + e.message); }
}

async function loadHomepage() {
  const status = document.getElementById("admin-homepage-status");
  status.textContent = "加载中...";
  const res = await adminFetch("/api/admin/homepage");
  const data = await res.json();
  if (!res.ok) {
    status.textContent = "";
    return alert(data.detail || "加载失败");
  }
  document.getElementById("hp-team-logo").value = data.team_logo_url || "";
  document.getElementById("hp-banner").value = data.banner_images ? JSON.stringify(data.banner_images, null, 2) : "";
  document.getElementById("hp-ach").value = data.featured_achievements ? JSON.stringify(data.featured_achievements, null, 2) : "";
  document.getElementById("hp-mem").value = data.featured_members ? JSON.stringify(data.featured_members, null, 2) : "";
  status.textContent = "已加载";
}

async function saveHomepage() {
  const status = document.getElementById("admin-homepage-status");
  status.textContent = "保存中...";
  let payload = {};
  try {
    payload = {
      team_logo_url: document.getElementById("hp-team-logo").value.trim() || null,
      banner_images: safeParseJson(document.getElementById("hp-banner").value),
      featured_achievements: safeParseJson(document.getElementById("hp-ach").value),
      featured_members: safeParseJson(document.getElementById("hp-mem").value),
    };
  } catch(e) {
    status.textContent = "";
    return alert(e.message);
  }

  const res = await adminFetch("/api/admin/homepage", {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload),
  });
  const data = await res.json();
  if (!res.ok) {
    status.textContent = "";
    return alert(data.detail || "保存失败");
  }
  status.textContent = "保存成功";
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btn-load-homepage")?.addEventListener("click", loadHomepage);
  document.getElementById("btn-save-homepage")?.addEventListener("click", saveHomepage);
  loadHomepage();
});
</script>
{% endblock %}
