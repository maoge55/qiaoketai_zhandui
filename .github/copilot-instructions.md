# Copilot Instructions for This Repo

- **Stack & entrypoint**: FastAPI app wires routers and static assets in [app/main.py](app/main.py); tables auto-created there but prefer Alembic migrations under [alembic/versions](alembic/versions).
- **Settings**: Configuration comes from [app/config.py](app/config.py) via `.env` (SQLALCHEMY_DATABASE_URL, JWT keys, SMTP creds, membership/admin codes). Use pydantic BaseSettings; keep secrets out of code.
- **DB access**: SQLAlchemy engine/session in [app/database.py](app/database.py) with `SessionLocal`; always inject sessions with `get_db` from [app/dependencies/auth.py](app/dependencies/auth.py) and close via dependency.
- **Auth model**: JWT bearer (`/api/auth/login`) defined in [app/dependencies/auth.py](app/dependencies/auth.py); roles ordered visitor→user→member→elite_member→admin with `require_role` helpers. Cookie-aware `get_current_user_from_cookie` exists for page rendering.
- **Password handling**: Frontend sends `password_md5`; backend treats it as plaintext and bcrypt-hashes it in [app/utils/security.py](app/utils/security.py). Normalizes to 72-byte max for bcrypt.
- **Token shaping**: JWT payload includes `user_id`, `sub`, `role`; created with `ACCESS_TOKEN_EXPIRE_MINUTES` (defaults to 1 year) in [app/utils/security.py](app/utils/security.py). Login sets `access_token` (HttpOnly), `user_role`, `user_nickname` cookies for a year in [app/routers/auth.py](app/routers/auth.py).
- **Registration & roles**: Register endpoint in [app/routers/auth.py](app/routers/auth.py) validates email codes, hashes md5 password, assigns roles by `ADMIN_EMAIL` or membership codes (`QK_*` envs, compare md5). Verification codes stored in `email_verification_codes` table.
- **Email sending**: SMTP via QQ in [app/utils/email.py](app/utils/email.py); reads sender, password, host/port from settings. `send_verification_code` relies on it.
- **Article flow**: CRUD in [app/routers/articles.py](app/routers/articles.py). Published-only listing; supports featured, search, category, tag filter. Content sanitized with [app/utils/sanitize.py](app/utils/sanitize.py) before save. Tags stored in `article_tags`.
- **Comments**: Article comments in [app/routers/comments.py](app/routers/comments.py); supports threaded replies, delete with recursive tree removal, pin/Unpin guarded by author/admin. SQL Server lacks `NULLS LAST`, so ordering avoids it.
- **Cards**: Card APIs in [app/routers/cards.py](app/routers/cards.py) filter by version/expansion/class/rarity/search and paginate. Expansions sorted by year parsed from expansion text. Note SQL Server ordering constraints (no `nullslast`).
- **Members**: Member endpoints in [app/routers/members.py](app/routers/members.py) list only member+ roles, sorted by influence then current season rank. Profiles editable by member; admin-only fields via `/api/admin/members/{id}/profile_admin`. Avatars saved under `app/static/avatars` hashed by email; size limited to 2MB.
- **Achievements**: Stored via `Achievement` model; member achievements exposed in [app/routers/members.py](app/routers/members.py) and highlighted on homepage config.
- **Admin surface**: [app/routers/admin.py](app/routers/admin.py) exposes role-guarded user paging, role updates, article status changes, and homepage config CRUD. Use `require_admin` dependency.
- **Homepage config**: Public fetch in [app/routers/homepage.py](app/routers/homepage.py); admin updates in [app/routers/admin.py](app/routers/admin.py). Initializes defaults if missing.
- **Schemas**: Response/request schemas consolidated in [app/schemas/__init__.py](app/schemas/__init__.py); ensure from_attributes is set when returning ORM models.
- **Models**: SQLAlchemy models in [app/models/__init__.py](app/models/__init__.py); note enums (`UserRole`, `ArticleStatus`), JSON fields (homepage config, card arena_win_rates), and relationships (Article.tags/comments, Card.reviews, User.profile).
- **Security hygiene**: Use `sanitize_html` when persisting user-provided HTML; if bleach unavailable, fallback strips `<script>` and `on*` attributes. JWT decode returns `None` on failure—check and raise proper HTTP errors.
- **Static & templates**: Static served from `app/static` (mounted at `/static`); avatars live there. HTML templates under [app/templates](app/templates) rendered via page routers (see [app/routers/pages.py](app/routers/pages.py) if adding pages).
- **DB backend assumptions**: Target is SQL Server; avoid unsupported constructs (e.g., `NULLS LAST`). Use explicit ordering as done in cards/comments/members.
- **Developer workflow**: Install deps via `pip install -r requirements.txt`; set `.env` (DB URL, JWT secret, email creds, membership codes). Apply migrations with `alembic upgrade head` (preferred) or rely on metadata create in app startup. Run API with `uvicorn app.main:app --reload` from repo root.
- **Testing/fixtures**: No automated tests present; use Alembic seeds or manual inserts for data. Keep SQL Server running before invoking API.
- **When extending**: Reuse dependency-injected DB sessions; guard role-specific endpoints with `require_role` helpers; sanitize HTML inputs; keep cookie shapes consistent with auth router; maintain influence/rank sorting semantics for member listings.
